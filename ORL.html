<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Танцевальная студия - CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Сайдбар */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #8a2387 0%, #e94057 50%, #f27121 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .logo span {
            color: #ffd166;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            border-left: 4px solid #ffd166;
        }

        .nav-link i {
            margin-right: 15px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 30px;
        }

        .header h2 {
            color: #8a2387;
            font-size: 28px;
        }

        /* Табло с датой и временем */
        .dashboard-clock {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .current-date {
            font-size: 18px;
            font-weight: 600;
            color: #8a2387;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .current-time {
            font-size: 28px;
            font-weight: 700;
            color: #e94057;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            letter-spacing: 2px;
        }

        /* Карточки статистики */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 24px;
        }

        .stat-card:nth-child(1) .stat-icon {
            background-color: #e3f2fd;
            color: #2196f3;
        }

        .stat-card:nth-child(2) .stat-icon {
            background-color: #f3e5f5;
            color: #8a2387;
        }

        .stat-card:nth-child(3) .stat-icon {
            background-color: #e8f5e9;
            color: #4caf50;
        }

        .stat-card:nth-child(4) .stat-icon {
            background-color: #fff3e0;
            color: #f27121;
        }

        .stat-info h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #666;
        }

        /* Секции контента */
        .content-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .section-title h3 {
            color: #8a2387;
            font-size: 22px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #8a2387;
            color: white;
        }

        .btn-primary:hover {
            background-color: #6a1b6f;
        }

        .btn-edit {
            background-color: #2196f3;
            color: white;
        }

        .btn-edit:hover {
            background-color: #0b7dda;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background-color: #d32f2f;
        }

        .btn-save {
            background-color: #4caf50;
            color: white;
        }

        .btn-save:hover {
            background-color: #388e3c;
        }

        .btn-cancel {
            background-color: #757575;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #616161;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-duplicate {
            background-color: #ff9800;
            color: white;
        }

        .btn-duplicate:hover {
            background-color: #e68900;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        /* Таблицы */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background-color: #f9f9f9;
            color: #8a2387;
            font-weight: 600;
        }

        table tr:hover {
            background-color: #f9f9f9;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background-color: #ffebee;
            color: #c62828;
        }

        .status-paid {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .status-pending {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .status-full {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-available {
            background-color: #d4edda;
            color: #155724;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        /* Формы */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: #8a2387;
            outline: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Расписание */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .schedule-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            background-color: #f9f9f9;
            transition: transform 0.3s;
            position: relative;
        }

        .schedule-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .schedule-card h4 {
            color: #8a2387;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .schedule-time {
            background-color: #e94057;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .schedule-info {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .schedule-info i {
            margin-right: 10px;
            color: #8a2387;
            width: 20px;
        }

        .capacity-bar {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .capacity-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .clients-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            max-height: 200px;
            overflow-y: auto;
        }

        .client-item {
            padding: 8px 10px;
            background-color: white;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #8a2387;
        }

        .client-name {
            font-weight: 500;
        }

        .client-phone {
            font-size: 12px;
            color: #666;
        }

        /* Настройки */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .settings-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            background-color: #f9f9f9;
        }

        .settings-card h4 {
            color: #8a2387;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-actions {
            display: flex;
            gap: 5px;
        }

        .price-badge {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #8a2387;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Дупликация занятий */
        .duplicate-options {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .duplicate-options h4 {
            color: #8a2387;
            margin-bottom: 10px;
        }

        .duplicate-days {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        /* Распределение клиентов */
        .distribution-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .distribution-section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
        }

        .distribution-section h4 {
            color: #8a2387;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .coach-clients {
            max-height: 400px;
            overflow-y: auto;
        }

        .coach-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .coach-name {
            font-weight: 600;
            color: #8a2387;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-count {
            background-color: #e94057;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* Пустые состояния */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #888;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                margin-bottom: 20px;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .container {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .duplicate-days {
                flex-direction: column;
            }
            
            .distribution-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-clock {
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Сайдбар -->
        <aside class="sidebar">
            <div class="logo">
                <h1>Танцевальная <span>CRM</span></h1>
                <p>Управление студией</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="dashboard">
                        <i class="fas fa-home"></i> Главная
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="coaches">
                        <i class="fas fa-users"></i> Тренеры
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="clients">
                        <i class="fas fa-user-friends"></i> Клиенты
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="schedule">
                        <i class="fas fa-calendar-alt"></i> Расписание
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="payments">
                        <i class="fas fa-credit-card"></i> Платежи
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="distribution">
                        <i class="fas fa-chart-pie"></i> Распределение
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="settings">
                        <i class="fas fa-cog"></i> Настройки
                    </a>
                </li>
                <li class="nav-item" style="margin-top: 30px;">
                    <a class="nav-link" id="export-data">
                        <i class="fas fa-download"></i> Экспорт данных
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="import-data">
                        <i class="fas fa-upload"></i> Импорт данных
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Основной контент -->
        <main class="main-content">
            <!-- Шапка с табло времени -->
            <header class="header">
                <h2 id="page-title">Главная панель</h2>
                <div class="dashboard-clock">
                    <div class="current-date" id="current-date"></div>
                    <div class="current-time" id="current-time"></div>
                </div>
            </header>
            
            <!-- Карточки статистики -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="coaches-count">0</h3>
                        <p>Тренеров</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="clients-count">0</h3>
                        <p>Клиентов</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="lessons-count">0</h3>
                        <p>Занятий сегодня</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="revenue-count">0 ₽</h3>
                        <p>Доход за месяц</p>
                    </div>
                </div>
            </div>
            
            <!-- Раздел тренеров -->
            <section id="coaches-section" class="content-section">
                <div class="section-title">
                    <h3>Тренеры</h3>
                    <button class="btn btn-primary" id="add-coach-btn">
                        <i class="fas fa-plus"></i> Добавить тренера
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="coaches-table">
                        <thead>
                            <tr>
                                <th>Имя</th>
                                <th>Направление</th>
                                <th>Телефон</th>
                                <th>Занятий/нед</th>
                                <th>Клиентов</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="coaches-table-body">
                            <!-- Данные загружаются через JS -->
                        </tbody>
                    </table>
                </div>
                <div id="coaches-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-users"></i>
                    <h4>Нет тренеров</h4>
                    <p>Добавьте первого тренера, нажав кнопку "Добавить тренера"</p>
                </div>
            </section>
            
            <!-- Раздел клиентов -->
            <section id="clients-section" class="content-section">
                <div class="section-title">
                    <h3>Клиенты</h3>
                    <button class="btn btn-primary" id="add-client-btn">
                        <i class="fas fa-plus"></i> Добавить клиента
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="clients-table">
                        <thead>
                            <tr>
                                <th>Имя</th>
                                <th>Телефон</th>
                                <th>Направление</th>
                                <th>Тренер</th>
                                <th>Занятие</th>
                                <th>Посещений</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                            <!-- Данные загружаются через JS -->
                        </tbody>
                    </table>
                </div>
                <div id="clients-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-user-friends"></i>
                    <h4>Нет клиентов</h4>
                    <p>Добавьте первого клиента, нажав кнопку "Добавить клиента"</p>
                </div>
            </section>
            
            <!-- Раздел расписания -->
            <section id="schedule-section" class="content-section">
                <div class="section-title">
                    <h3>Расписание на неделю</h3>
                    <div>
                        <button class="btn btn-secondary" id="week-view-btn">
                            <i class="fas fa-calendar-week"></i> Показать неделю
                        </button>
                        <button class="btn btn-primary" id="add-lesson-btn">
                            <i class="fas fa-plus"></i> Добавить занятие
                        </button>
                    </div>
                </div>
                <div id="week-schedule" style="display: none;">
                    <!-- Недельное расписание будет загружено через JS -->
                </div>
                <div class="schedule-grid" id="schedule-container">
                    <!-- Занятия загружаются через JS -->
                </div>
                <div id="schedule-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>Нет занятий</h4>
                    <p>Добавьте первое занятие, нажав кнопку "Добавить занятие"</p>
                </div>
            </section>
            
            <!-- Раздел платежей -->
            <section id="payments-section" class="content-section">
                <div class="section-title">
                    <h3>Платежи</h3>
                    <button class="btn btn-primary" id="add-payment-btn">
                        <i class="fas fa-plus"></i> Добавить платеж
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="payments-table">
                        <thead>
                            <tr>
                                <th>Клиент</th>
                                <th>Дата</th>
                                <th>Сумма</th>
                                <th>Тип</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table-body">
                            <!-- Данные загружаются через JS -->
                        </tbody>
                    </table>
                </div>
                <div id="payments-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-credit-card"></i>
                    <h4>Нет платежей</h4>
                    <p>Добавьте первый платеж, нажав кнопку "Добавить платеж"</p>
                </div>
            </section>
            
            <!-- Раздел распределения -->
            <section id="distribution-section" class="content-section">
                <div class="section-title">
                    <h3>Распределение клиентов</h3>
                    <button class="btn btn-info" id="refresh-distribution">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
                
                <div class="distribution-container">
                    <div class="distribution-section">
                        <h4>Клиенты по тренерам</h4>
                        <div class="coach-clients" id="coach-distribution">
                            <!-- Распределение по тренерам загружается через JS -->
                        </div>
                    </div>
                    
                    <div class="distribution-section">
                        <h4>Наполняемость занятий</h4>
                        <div class="coach-clients" id="lessons-distribution">
                            <!-- Распределение по занятиям загружается через JS -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Раздел настроек -->
            <section id="settings-section" class="content-section">
                <div class="section-title">
                    <h3>Настройки</h3>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-card">
                        <h4>Направления танцев</h4>
                        <div id="dance-styles-list">
                            <!-- Направления загружаются через JS -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" id="add-style-btn">
                                <i class="fas fa-plus"></i> Добавить направление
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h4>Стоимость занятий</h4>
                        <div id="prices-list">
                            <!-- Цены загружаются через JS -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" id="add-price-btn">
                                <i class="fas fa-plus"></i> Добавить стоимость
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h4>Типы платежей</h4>
                        <div id="payment-types-list">
                            <!-- Типы платежей загружаются через JS -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" id="add-payment-type-btn">
                                <i class="fas fa-plus"></i> Добавить тип
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h4>Дни недели</h4>
                        <div id="week-days-list">
                            <!-- Дни недели загружаются через JS -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Главная страница -->
            <section id="dashboard-section" class="content-section active">
                <div class="section-title">
                    <h3>Ближайшие занятия (сегодня)</h3>
                    <button class="btn btn-info" id="refresh-today">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
                <div class="schedule-grid" id="upcoming-lessons">
                    <!-- Ближайшие занятия загружаются через JS -->
                </div>
                <div id="dashboard-lessons-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>Нет занятий на сегодня</h4>
                    <p>Добавьте занятия в разделе "Расписание"</p>
                </div>
                
                <div class="section-title" style="margin-top: 40px;">
                    <h3>Недавние платежи</h3>
                    <button class="btn btn-info" id="refresh-payments">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="recent-payments-table">
                        <thead>
                            <tr>
                                <th>Клиент</th>
                                <th>Дата</th>
                                <th>Сумма</th>
                                <th>Тип</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody id="recent-payments-body">
                            <!-- Данные загружаются через JS -->
                        </tbody>
                    </table>
                </div>
                <div id="dashboard-payments-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-credit-card"></i>
                    <h4>Нет платежей</h4>
                    <p>Добавьте платежи в разделе "Платежи"</p>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Модальное окно для тренера -->
    <div class="modal" id="coach-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="coach-modal-title">Добавить тренера</h3>
                <button class="close-modal" id="close-coach-modal">&times;</button>
            </div>
            <form id="coach-form">
                <input type="hidden" id="coach-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="coach-name">Имя и фамилия *</label>
                        <input type="text" id="coach-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="coach-phone">Телефон *</label>
                        <input type="tel" id="coach-phone" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="coach-style">Направление танцев *</label>
                        <select id="coach-style" class="form-control" required>
                            <option value="">Выберите направление</option>
                            <!-- Направления загружаются через JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="coach-classes">Занятий в неделю *</label>
                        <input type="number" id="coach-classes" class="form-control" min="1" max="30" value="10" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="coach-status">Статус *</label>
                    <select id="coach-status" class="form-control" required>
                        <option value="Активен">Активен</option>
                        <option value="Неактивен">Неактивен</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="cancel-coach">Отмена</button>
                    <button type="submit" class="btn btn-save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно для клиента -->
    <div class="modal" id="client-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="client-modal-title">Добавить клиента</h3>
                <button class="close-modal" id="close-client-modal">&times;</button>
            </div>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-name">Имя и фамилия *</label>
                        <input type="text" id="client-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="client-phone">Телефон *</label>
                        <input type="tel" id="client-phone" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-email">Email</label>
                        <input type="email" id="client-email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="client-birthdate">Дата рождения</label>
                        <input type="date" id="client-birthdate" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-style">Направление танцев *</label>
                        <select id="client-style" class="form-control" required>
                            <option value="">Выберите направление</option>
                            <!-- Направления загружаются через JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="client-coach">Тренер *</label>
                        <select id="client-coach" class="form-control" required>
                            <option value="">Выберите тренера</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-lesson">Занятие (опционально)</label>
                        <select id="client-lesson" class="form-control">
                            <option value="">Не выбрано</option>
                            <!-- Занятия загружаются через JS -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="cancel-client">Отмена</button>
                    <button type="submit" class="btn btn-save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно для занятия -->
    <div class="modal" id="lesson-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lesson-modal-title">Добавить занятие</h3>
                <button class="close-modal" id="close-lesson-modal">&times;</button>
            </div>
            <form id="lesson-form">
                <input type="hidden" id="lesson-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="lesson-title">Название занятия *</label>
                        <input type="text" id="lesson-title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="lesson-style">Направление *</label>
                        <select id="lesson-style" class="form-control" required>
                            <option value="">Выберите направление</option>
                            <!-- Направления загружаются через JS -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="lesson-day">День недели *</label>
                        <select id="lesson-day" class="form-control" required>
                            <option value="">Выберите день</option>
                            <!-- Дни недели загружаются через JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lesson-time">Время *</label>
                        <input type="text" id="lesson-time" class="form-control" placeholder="18:00 - 19:30" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="lesson-coach">Тренер *</label>
                        <select id="lesson-coach" class="form-control" required>
                            <option value="">Выберите тренера</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lesson-max-clients">Макс. клиентов *</label>
                        <input type="number" id="lesson-max-clients" class="form-control" min="1" max="50" value="12" required>
                    </div>
                </div>
                
                <!-- Опции дублирования -->
                <div class="duplicate-options" id="duplicate-section" style="display: none;">
                    <h4>Дублировать занятие на другие дни</h4>
                    <p>Выберите дни, на которые нужно создать такие же занятия:</p>
                    <div class="duplicate-days" id="duplicate-days">
                        <!-- Дни недели загружаются через JS -->
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="duplicate-all-weeks">
                            Дублировать на 4 недели вперед
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="toggle-duplicate-btn">
                        <i class="fas fa-copy"></i> Добавить дублирование
                    </button>
                    <button type="button" class="btn btn-cancel" id="cancel-lesson">Отмена</button>
                    <button type="submit" class="btn btn-save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно для платежа -->
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="payment-modal-title">Добавить платеж</h3>
                <button class="close-modal" id="close-payment-modal">&times;</button>
            </div>
            <form id="payment-form">
                <input type="hidden" id="payment-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-client">Клиент *</label>
                        <select id="payment-client" class="form-control" required>
                            <option value="">Выберите клиента</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-date">Дата *</label>
                        <input type="date" id="payment-date" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-amount">Сумма (₽) *</label>
                        <input type="number" id="payment-amount" class="form-control" min="0" step="100" required>
                    </div>
                    <div class="form-group">
                        <label for="payment-type">Тип платежа *</label>
                        <select id="payment-type" class="form-control" required>
                            <option value="">Выберите тип</option>
                            <!-- Типы платежей загружаются через JS -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payment-status">Статус *</label>
                    <select id="payment-status" class="form-control" required>
                        <option value="Оплачен">Оплачен</option>
                        <option value="В ожидании">В ожидании</option>
                        <option value="Отменен">Отменен</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-notes">Примечания</label>
                    <textarea id="payment-notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="cancel-payment">Отмена</button>
                    <button type="submit" class="btn btn-save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно для настроек -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="settings-modal-title">Настройка</h3>
                <button class="close-modal" id="close-settings-modal">&times;</button>
            </div>
            <form id="settings-form">
                <input type="hidden" id="settings-id">
                <input type="hidden" id="settings-type">
                <div class="form-group">
                    <label for="settings-name">Название *</label>
                    <input type="text" id="settings-name" class="form-control" required>
                </div>
                <div class="form-group" id="settings-price-container" style="display: none;">
                    <label for="settings-price">Стоимость (₽) *</label>
                    <input type="number" id="settings-price" class="form-control" min="0" step="100">
                </div>
                <div class="form-group" id="settings-duration-container" style="display: none;">
                    <label for="settings-duration">Период действия</label>
                    <input type="text" id="settings-duration" class="form-control" placeholder="8 занятий" value="8 занятий">
                </div>
                <div class="form-group" id="settings-description-container">
                    <label for="settings-description">Описание</label>
                    <textarea id="settings-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="cancel-settings">Отмена</button>
                    <button type="submit" class="btn btn-save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Класс CRM системы
        class DanceCRM {
            constructor() {
                // Загружаем данные из localStorage или создаем пустые массивы
                this.coaches = this.loadFromStorage('danceCRM_coaches') || [];
                this.clients = this.loadFromStorage('danceCRM_clients') || [];
                this.lessons = this.loadFromStorage('danceCRM_lessons') || [];
                this.payments = this.loadFromStorage('danceCRM_payments') || []; // Пустой массив платежей
                this.settings = this.loadFromStorage('danceCRM_settings') || this.getDefaultSettings();
                this.nextIds = {
                    coach: this.loadFromStorage('danceCRM_nextIds')?.coach || 1,
                    client: this.loadFromStorage('danceCRM_nextIds')?.client || 1,
                    lesson: this.loadFromStorage('danceCRM_nextIds')?.lesson || 1,
                    payment: this.loadFromStorage('danceCRM_nextIds')?.payment || 1,
                    setting: this.loadFromStorage('danceCRM_nextIds')?.setting || 1
                };
            }

            getDefaultSettings() {
                return {
                    danceStyles: [
                        // Малыши 3-7 лет
                        { 
                            id: 1, 
                            name: "Танец-игра / Ритмика", 
                            description: "Развитие чувства ритма, координации и любви к движению через веселые игры и простые танцевальные комбинации.",
                            schedule: "Понедельник и четверг в 17:30",
                            ageGroup: "3-7 лет",
                            icon: "🎵"
                        },
                        { 
                            id: 2, 
                            name: "Азбука классического танца", 
                            description: "Первое знакомство с основами балета в игровой форме. Постановка корпуса, развитие гибкости и музыкальности.",
                            schedule: "Понедельник и четверг в 18:30",
                            ageGroup: "3-7 лет",
                            icon: "🩰"
                        },
                        { 
                            id: 3, 
                            name: "Беби-мульт-денс", 
                            description: "Зажигательные танцы под любимые детские песни и мелодии из мультфильмов. Идеально для раскрепощения.",
                            schedule: "Среда, Суббота 17:30",
                            ageGroup: "3-7 лет",
                            icon: "📺"
                        },
                        
                        // Дети 8-12 лет
                        { 
                            id: 4, 
                            name: "Классическая хореография", 
                            description: "Углубленное изучение основ балета. Укрепление мышечного корсета, развитие выносливости, грации и дисциплины.",
                            schedule: "-----",
                            ageGroup: "8-12 лет",
                            icon: "🌟"
                        },
                        { 
                            id: 5, 
                            name: "Современный танец", 
                            description: "Изучение энергичных и популярных стилей: хип-хоп, джаз-модерн. Работа над ритмом, стилем и импровизацией.",
                            schedule: "Среда, Суббота в 16:00",
                            ageGroup: "8-12 лет",
                            icon: "🔥"
                        },
                        { 
                            id: 6, 
                            name: "Эстрадный танец", 
                            description: "Яркое и зрелищное направление, сочетающее элементы классики, народного и современного танца.",
                            schedule: "----",
                            ageGroup: "8-12 лет",
                            icon: "🎭"
                        },
                        
                        // Подростки 13-17 лет
                        { 
                            id: 7, 
                            name: "Современная хореография (Contemporary)", 
                            description: "Выразительный танец, основанный на эмоциях и естественности движения. Развитие пластики и творческого потенциала.",
                            schedule: "----",
                            ageGroup: "13-17 лет",
                            icon: "💧"
                        },
                        { 
                            id: 8, 
                            name: "Хип-хоп (Old School)", 
                            description: "Изучение истоков уличной культуры. Мощные и техничные стили: Breaking, Popping, Locking.",
                            schedule: "----",
                            ageGroup: "13-17 лет",
                            icon: "👟"
                        },
                        { 
                            id: 9, 
                            name: "Хип-хоп (New Style)", 
                            description: "Современные уличные тенденции. Стили, популярные в клипах и на мировых танцполах.",
                            schedule: "Четверг, Суббота в 19:00",
                            ageGroup: "13-17 лет",
                            icon: "🎧"
                        },
                        
                        // Взрослые 18-44 лет
                        { 
                            id: 10, 
                            name: "Танец для души (Contemporary, Modern Dance)", 
                            description: "Свободный танец, помогающий снять напряжение, выразить чувства и улучшить физическую форму.",
                            schedule: "Понедельник и Среда в 19:00",
                            ageGroup: "18-44 лет",
                            icon: "🧘"
                        },
                        { 
                            id: 11, 
                            name: "Хип-хоп для взрослых", 
                            description: "Динамичное кардио, развитие чувства ритма и уверенности в себе. Подходит для любого уровня подготовки.",
                            schedule: "----",
                            ageGroup: "18-44 лет",
                            icon: "💪"
                        },
                        { 
                            id: 12, 
                            name: "High Heels / Lady Dance", 
                            description: "Стильный и женственный танец на каблуках. Развитие грации, сексуальности и уверенности в себе.",
                            schedule: "----",
                            ageGroup: "18-44 лет",
                            icon: "👠"
                        },
                        
                        // Взрослые 25+ лет
                        { 
                            id: 13, 
                            name: "Lady Dance, High Heels", 
                            description: "Элегантный танец, подчеркивающий женственность и пластику. Элементы джаза, стрип-пластики и современных стилей.",
                            schedule: "----",
                            ageGroup: "25+ лет",
                            icon: "💃"
                        },
                        { 
                            id: 14, 
                            name: "Contemporary, Modern Dance", 
                            description: "Гармоничное сочетание физической нагрузки и творческого самовыражения. Улучшение осанки, гибкости и координации.",
                            schedule: "----",
                            ageGroup: "25+ лет",
                            icon: "🌿"
                        },
                        { 
                            id: 15, 
                            name: "Body Ballet для взрослых", 
                            description: "Упрощенная и адаптированная версия классического балета для взрослых. Идеально для формирования красивой осанки.",
                            schedule: "----",
                            ageGroup: "25+ лет",
                            icon: "🩰"
                        },
                        
                        // Взрослые 45+ лет
                        { 
                            id: 16, 
                            name: "Lady Dance для женщин 45+", 
                            description: "Элегантный танец, подчеркивающий женственность и пластику. Специально адаптированные занятия.",
                            schedule: "----",
                            ageGroup: "45+ лет",
                            icon: "🌺"
                        },
                        { 
                            id: 17, 
                            name: "Body Ballet 45+", 
                            description: "Адаптированная программа классического балета для женщин 45+. Укрепление мышц, улучшение осанки, развитие гибкости.",
                            schedule: "-----",
                            ageGroup: "45+ лет",
                            icon: "🌟"
                        },
                        { 
                            id: 18, 
                            name: "Социальные танцы", 
                            description: "Прекрасный способ поддерживать активность, улучшать координацию, память и обретать новые знакомства.",
                            schedule: "---",
                            ageGroup: "45+ лет",
                            icon: "💃"
                        }
                    ],
                    prices: [
                        {
                            id: 1,
                            name: "ПРОБНОЕ ЗАНЯТИЕ ДЕТСКОЕ",
                            price: 350,
                            period: "1 занятие",
                            description: "Знакомство со студией",
                            features: [
                                "Знакомство со студией",
                                "Консультация педагога",
                                "Определение уровня",
                                "Подбор направления"
                            ],
                            ageGroup: "3-12 лет"
                        },
                        {
                            id: 2,
                            name: "ПРОБНОЕ ЗАНЯТИЕ ВЗРОСЛОЕ",
                            price: 400,
                            period: "1 занятие",
                            description: "Знакомство со студией",
                            features: [
                                "Знакомство со студией",
                                "Консультация педагога",
                                "Определение уровня",
                                "Подбор направления"
                            ],
                            ageGroup: "18+ лет"
                        },
                        {
                            id: 3,
                            name: "ДЕТСКИЙ (3-12 лет)",
                            price: 3000,
                            period: "8 занятий",
                            description: "Абонемент на 30 дней",
                            features: [
                                "Абонемент на 30 дней",
                                "Любое детское направление",
                                "Заморозка на 7 дней",
                                "Скидка на 2-го ребенка"
                            ],
                            ageGroup: "3-12 лет"
                        },
                        {
                            id: 4,
                            name: "ПОДРОСТКИ (13-17 лет)",
                            price: 3000,
                            period: "8 занятий",
                            description: "Абонемент на 30 дней",
                            features: [
                                "Абонемент на 30 дней",
                                "Современные направления",
                                "Подготовка к выступлениям",
                                "Участие в конкурсах"
                            ],
                            ageGroup: "13-17 лет"
                        },
                        {
                            id: 5,
                            name: "ВЗРОСЛЫЕ (18+ лет)",
                            price: 4000,
                            period: "8 занятий",
                            description: "Абонемент на 30 дней",
                            features: [
                                "Абонемент на 30 дней",
                                "Все взрослые направления",
                                "Индивидуальный подход",
                                "Гибкое расписание"
                            ],
                            ageGroup: "18+ лет"
                        },
                        {
                            id: 6,
                            name: "ВЗРОСЛЫЕ 45+",
                            price: 4000,
                            period: "8 занятий",
                            description: "Абонемент на 30 дней",
                            features: [
                                "Абонемент на 30 дней",
                                "Адаптированные нагрузки",
                                "Щадящие тренировки",
                                "Оздоровительный эффект"
                            ],
                            ageGroup: "45+ лет"
                        },
                        {
                            id: 7,
                            name: "ИНДИВИДУАЛЬНО",
                            price: 1500,
                            period: "1 занятие (60 мин)",
                            description: "Персональный подход",
                            features: [
                                "Персональный подход",
                                "Гибкий график",
                                "Индивидуальная программа",
                                "Быстрый прогресс"
                            ],
                            ageGroup: "Все возраста"
                        },
                        {
                            id: 8,
                            name: "ИНДИВИДУАЛЬНО ПО ЗАПРОСУ",
                            price: 0,
                            period: "1 занятие (60 мин)",
                            description: "Персональный подход",
                            features: [
                                "Персональный подход",
                                "Гибкий график",
                                "Индивидуальная программа"
                            ],
                            ageGroup: "Все возраста"
                        }
                    ],
                    paymentTypes: [
                        { id: 1, name: "Пробное занятие", description: "Оплата пробного занятия" },
                        { id: 2, name: "Абонемент", description: "Оплата абонемента" },
                        { id: 3, name: "Индивидуальное", description: "Индивидуальное занятие" },
                        { id: 4, name: "Разовое", description: "Разовое занятие" },
                        { id: 5, name: "Другое", description: "Прочие платежи" }
                    ],
                    weekDays: [
                        { id: 1, name: "Понедельник", shortName: "Пн", order: 1 },
                        { id: 2, name: "Вторник", shortName: "Вт", order: 2 },
                        { id: 3, name: "Среда", shortName: "Ср", order: 3 },
                        { id: 4, name: "Четверг", shortName: "Чт", order: 4 },
                        { id: 5, name: "Пятница", shortName: "Пт", order: 5 },
                        { id: 6, name: "Суббота", shortName: "Сб", order: 6 },
                        { id: 7, name: "Воскресенье", shortName: "Вс", order: 7 }
                    ]
                };
            }

            // Сохранение и загрузка данных
            saveToStorage(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Ошибка сохранения в localStorage:', e);
                    return false;
                }
            }

            loadFromStorage(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Ошибка загрузки из localStorage:', e);
                    return null;
                }
            }

            saveAll() {
                this.saveToStorage('danceCRM_coaches', this.coaches);
                this.saveToStorage('danceCRM_clients', this.clients);
                this.saveToStorage('danceCRM_lessons', this.lessons);
                this.saveToStorage('danceCRM_payments', this.payments);
                this.saveToStorage('danceCRM_settings', this.settings);
                this.saveToStorage('danceCRM_nextIds', this.nextIds);
            }

            // Настройки
            getDanceStyles() {
                return this.settings.danceStyles || [];
            }

            addDanceStyle(style) {
                style.id = this.nextIds.setting++;
                if (!this.settings.danceStyles) this.settings.danceStyles = [];
                this.settings.danceStyles.push(style);
                this.saveAll();
                return style.id;
            }

            updateDanceStyle(id, styleData) {
                const index = this.settings.danceStyles.findIndex(s => s.id === id);
                if (index !== -1) {
                    this.settings.danceStyles[index] = { ...this.settings.danceStyles[index], ...styleData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deleteDanceStyle(id) {
                const index = this.settings.danceStyles.findIndex(s => s.id === id);
                if (index !== -1) {
                    this.settings.danceStyles.splice(index, 1);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getPrices() {
                return this.settings.prices || [];
            }

            addPrice(price) {
                price.id = this.nextIds.setting++;
                if (!this.settings.prices) this.settings.prices = [];
                this.settings.prices.push(price);
                this.saveAll();
                return price.id;
            }

            updatePrice(id, priceData) {
                const index = this.settings.prices.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.settings.prices[index] = { ...this.settings.prices[index], ...priceData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deletePrice(id) {
                const index = this.settings.prices.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.settings.prices.splice(index, 1);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getPaymentTypes() {
                return this.settings.paymentTypes || [];
            }

            addPaymentType(type) {
                type.id = this.nextIds.setting++;
                if (!this.settings.paymentTypes) this.settings.paymentTypes = [];
                this.settings.paymentTypes.push(type);
                this.saveAll();
                return type.id;
            }

            updatePaymentType(id, typeData) {
                const index = this.settings.paymentTypes.findIndex(t => t.id === id);
                if (index !== -1) {
                    this.settings.paymentTypes[index] = { ...this.settings.paymentTypes[index], ...typeData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deletePaymentType(id) {
                const index = this.settings.paymentTypes.findIndex(t => t.id === id);
                if (index !== -1) {
                    this.settings.paymentTypes.splice(index, 1);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getWeekDays() {
                return this.settings.weekDays || [];
            }

            // Тренеры
            addCoach(coach) {
                coach.id = this.nextIds.coach++;
                this.coaches.push(coach);
                this.saveAll();
                return coach.id;
            }

            updateCoach(id, coachData) {
                const index = this.coaches.findIndex(c => c.id === id);
                if (index !== -1) {
                    this.coaches[index] = { ...this.coaches[index], ...coachData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deleteCoach(id) {
                const index = this.coaches.findIndex(c => c.id === id);
                if (index !== -1) {
                    this.coaches.splice(index, 1);
                    // Удаляем клиентов этого тренера
                    this.clients = this.clients.filter(c => c.coachId !== id);
                    // Удаляем занятия этого тренера
                    this.lessons = this.lessons.filter(l => l.coachId !== id);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getCoach(id) {
                return this.coaches.find(c => c.id === id);
            }

            getActiveCoaches() {
                return this.coaches.filter(c => c.status === 'Активен');
            }

            getCoachClients(coachId) {
                return this.clients.filter(c => c.coachId === coachId);
            }

            // Клиенты
            addClient(client) {
                client.id = this.nextIds.client++;
                client.visits = client.visits || 0;
                // Если указано занятие, увеличиваем счетчик клиентов в занятии
                if (client.lessonId) {
                    const lesson = this.getLesson(client.lessonId);
                    if (lesson) {
                        lesson.clients = (lesson.clients || 0) + 1;
                    }
                }
                this.clients.push(client);
                this.saveAll();
                return client.id;
            }

            updateClient(id, clientData) {
                const index = this.clients.findIndex(c => c.id === id);
                if (index !== -1) {
                    const oldLessonId = this.clients[index].lessonId;
                    const newLessonId = clientData.lessonId;
                    
                    // Обновляем счетчики в занятиях если изменилось занятие
                    if (oldLessonId !== newLessonId) {
                        if (oldLessonId) {
                            const oldLesson = this.getLesson(oldLessonId);
                            if (oldLesson && oldLesson.clients > 0) {
                                oldLesson.clients -= 1;
                            }
                        }
                        if (newLessonId) {
                            const newLesson = this.getLesson(newLessonId);
                            if (newLesson) {
                                newLesson.clients = (newLesson.clients || 0) + 1;
                            }
                        }
                    }
                    
                    this.clients[index] = { ...this.clients[index], ...clientData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deleteClient(id) {
                const index = this.clients.findIndex(c => c.id === id);
                if (index !== -1) {
                    const client = this.clients[index];
                    // Уменьшаем счетчик клиентов в занятии
                    if (client.lessonId) {
                        const lesson = this.getLesson(client.lessonId);
                        if (lesson && lesson.clients > 0) {
                            lesson.clients -= 1;
                        }
                    }
                    
                    this.clients.splice(index, 1);
                    // Удаляем платежи этого клиента
                    this.payments = this.payments.filter(p => p.clientId !== id);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getClient(id) {
                return this.clients.find(c => c.id === id);
            }

            getClientsByLesson(lessonId) {
                return this.clients.filter(c => c.lessonId === lessonId);
            }

            // Занятия
            addLesson(lesson) {
                lesson.id = this.nextIds.lesson++;
                lesson.clients = lesson.clients || 0;
                this.lessons.push(lesson);
                this.saveAll();
                return lesson.id;
            }

            addLessons(lessons) {
                const createdIds = [];
                lessons.forEach(lesson => {
                    lesson.id = this.nextIds.lesson++;
                    lesson.clients = lesson.clients || 0;
                    this.lessons.push(lesson);
                    createdIds.push(lesson.id);
                });
                this.saveAll();
                return createdIds;
            }

            updateLesson(id, lessonData) {
                const index = this.lessons.findIndex(l => l.id === id);
                if (index !== -1) {
                    this.lessons[index] = { ...this.lessons[index], ...lessonData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deleteLesson(id) {
                const index = this.lessons.findIndex(l => l.id === id);
                if (index !== -1) {
                    // Удаляем ссылки на занятие у клиентов
                    this.clients.forEach(client => {
                        if (client.lessonId === id) {
                            client.lessonId = null;
                        }
                    });
                    this.lessons.splice(index, 1);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getLesson(id) {
                return this.lessons.find(l => l.id === id);
            }

            getLessonsByDay(day) {
                return this.lessons.filter(l => l.day === day);
            }

            getLessonsByCoach(coachId) {
                return this.lessons.filter(l => l.coachId === coachId);
            }

            // Платежи
            addPayment(payment) {
                payment.id = this.nextIds.payment++;
                this.payments.push(payment);
                this.saveAll();
                return payment.id;
            }

            updatePayment(id, paymentData) {
                const index = this.payments.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.payments[index] = { ...this.payments[index], ...paymentData };
                    this.saveAll();
                    return true;
                }
                return false;
            }

            deletePayment(id) {
                const index = this.payments.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.payments.splice(index, 1);
                    this.saveAll();
                    return true;
                }
                return false;
            }

            getPayment(id) {
                return this.payments.find(p => p.id === id);
            }

            // Статистика
            getStats() {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                // Рассчитываем доход только по оплаченным платежам текущего месяца
                const monthlyRevenue = this.payments
                    .filter(p => {
                        try {
                            const paymentDate = new Date(p.date);
                            return p.status === 'Оплачен' && 
                                   paymentDate.getMonth() === currentMonth &&
                                   paymentDate.getFullYear() === currentYear;
                        } catch {
                            return false;
                        }
                    })
                    .reduce((sum, p) => sum + (parseInt(p.amount) || 0), 0);

                // Получаем занятия на сегодня
                const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                const todayName = days[today.getDay()];
                const todayLessons = this.lessons.filter(l => l.day === todayName).length;

                return {
                    coaches: this.coaches.length,
                    clients: this.clients.length,
                    lessons: todayLessons,
                    revenue: monthlyRevenue
                };
            }

            // Распределение клиентов
            getDistributionData() {
                const coachDistribution = {};
                const lessonDistribution = {};
                
                // Распределение по тренерам
                this.coaches.forEach(coach => {
                    const clients = this.getCoachClients(coach.id);
                    coachDistribution[coach.id] = {
                        coach,
                        clients,
                        count: clients.length
                    };
                });
                
                // Распределение по занятиям
                this.lessons.forEach(lesson => {
                    const clients = this.getClientsByLesson(lesson.id);
                    const coach = this.getCoach(lesson.coachId);
                    const capacityPercent = lesson.maxClients > 0 
                        ? Math.round((clients.length / lesson.maxClients) * 100)
                        : 0;
                        
                    lessonDistribution[lesson.id] = {
                        lesson,
                        coach,
                        clients,
                        count: clients.length,
                        capacity: capacityPercent
                    };
                });
                
                return {
                    coaches: coachDistribution,
                    lessons: lessonDistribution
                };
            }

            // Экспорт/Импорт данных
            exportData() {
                const data = {
                    coaches: this.coaches,
                    clients: this.clients,
                    lessons: this.lessons,
                    payments: this.payments,
                    settings: this.settings,
                    nextIds: this.nextIds,
                    exportedAt: new Date().toISOString()
                };
                return JSON.stringify(data, null, 2);
            }

            importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    
                    if (data.coaches) this.coaches = data.coaches;
                    if (data.clients) this.clients = data.clients;
                    if (data.lessons) this.lessons = data.lessons;
                    if (data.payments) this.payments = data.payments;
                    if (data.settings) this.settings = data.settings;
                    if (data.nextIds) this.nextIds = data.nextIds;
                    
                    this.saveAll();
                    return true;
                } catch (e) {
                    console.error('Ошибка импорта данных:', e);
                    return false;
                }
            }
        }

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Создаем экземпляр CRM
            window.crm = new DanceCRM();
            
            // Инициализация компонентов
            initClock();
            initNavigation();
            initModals();
            initForms();
            loadAllData();
            initExportImport();
            initScheduleView();
            initRefreshButtons();
            
            // Обновляем время каждую секунду
            setInterval(updateClock, 1000);
        });

        // Функции работы с интерфейсом
        function initClock() {
            updateClock();
        }

        function updateClock() {
            const now = new Date();
            
            // Форматируем дату
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('ru-RU', dateOptions);
            
            // Форматируем время
            const timeString = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('current-date').textContent = dateString;
            document.getElementById('current-time').textContent = timeString;
        }

        function initRefreshButtons() {
            document.getElementById('refresh-today').addEventListener('click', function() {
                loadTodayLessons();
                showNotification('Сегодняшние занятия обновлены', 'success');
            });
            
            document.getElementById('refresh-payments').addEventListener('click', function() {
                loadRecentPayments();
                showNotification('Платежи обновлены', 'success');
            });
            
            document.getElementById('refresh-distribution').addEventListener('click', function() {
                loadDistribution();
                showNotification('Распределение обновлено', 'success');
            });
        }

        function initNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Удаляем активный класс у всех ссылок
                    document.querySelectorAll('.nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Добавляем активный класс к текущей ссылке
                    this.classList.add('active');
                    
                    // Скрываем все секции
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Показываем нужную секцию
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        const sectionElement = document.getElementById(`${sectionId}-section`);
                        if (sectionElement) {
                            sectionElement.classList.add('active');
                            
                            // Обновляем заголовок страницы
                            const pageTitles = {
                                'dashboard': 'Главная панель',
                                'coaches': 'Тренеры',
                                'clients': 'Клиенты',
                                'schedule': 'Расписание',
                                'payments': 'Платежи',
                                'distribution': 'Распределение',
                                'settings': 'Настройки'
                            };
                            document.getElementById('page-title').textContent = pageTitles[sectionId];
                            
                            // Обновляем данные при переключении разделов
                            if (sectionId === 'schedule') {
                                updateWeekScheduleView();
                            }
                            if (sectionId === 'distribution') {
                                loadDistribution();
                            }
                        }
                    }
                });
            });
        }

        function initScheduleView() {
            document.getElementById('week-view-btn').addEventListener('click', function() {
                const weekSchedule = document.getElementById('week-schedule');
                const scheduleContainer = document.getElementById('schedule-container');
                
                if (weekSchedule.style.display === 'none') {
                    weekSchedule.style.display = 'block';
                    scheduleContainer.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-th-large"></i> Показать сетку';
                    updateWeekScheduleView();
                } else {
                    weekSchedule.style.display = 'none';
                    scheduleContainer.style.display = 'grid';
                    this.innerHTML = '<i class="fas fa-calendar-week"></i> Показать неделю';
                }
            });
        }

        function initModals() {
            // Закрытие модальных окон
            document.querySelectorAll('.close-modal, .btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            // Закрытие по клику вне окна
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Кнопки открытия модальных окон
            document.getElementById('add-coach-btn').addEventListener('click', () => openCoachModal());
            document.getElementById('add-client-btn').addEventListener('click', () => openClientModal());
            document.getElementById('add-lesson-btn').addEventListener('click', () => openLessonModal());
            document.getElementById('add-payment-btn').addEventListener('click', () => openPaymentModal());
            
            // Кнопки настроек
            document.getElementById('add-style-btn').addEventListener('click', () => openSettingsModal('danceStyle'));
            document.getElementById('add-price-btn').addEventListener('click', () => openSettingsModal('price'));
            document.getElementById('add-payment-type-btn').addEventListener('click', () => openSettingsModal('paymentType'));
            
            // Кнопка дублирования занятий
            document.getElementById('toggle-duplicate-btn').addEventListener('click', function() {
                const duplicateSection = document.getElementById('duplicate-section');
                if (duplicateSection.style.display === 'none') {
                    duplicateSection.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-times"></i> Убрать дублирование';
                    this.classList.remove('btn-secondary');
                    this.classList.add('btn-duplicate');
                    loadDuplicateDays();
                } else {
                    duplicateSection.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-copy"></i> Добавить дублирование';
                    this.classList.remove('btn-duplicate');
                    this.classList.add('btn-secondary');
                }
            });
        }

        function initForms() {
            document.getElementById('coach-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCoach();
            });
            
            document.getElementById('client-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveClient();
            });
            
            document.getElementById('lesson-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveLesson();
            });
            
            document.getElementById('payment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePayment();
            });
            
            document.getElementById('settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSetting();
            });
        }

        function initExportImport() {
            document.getElementById('export-data').addEventListener('click', function(e) {
                e.preventDefault();
                exportData();
            });
            
            document.getElementById('import-data').addEventListener('click', function(e) {
                e.preventDefault();
                importData();
            });
        }

        function loadAllData() {
            updateStats();
            loadCoachesTable();
            loadClientsTable();
            loadSchedule();
            loadPaymentsTable();
            loadTodayLessons();
            loadRecentPayments();
            loadSettings();
        }

        function updateStats() {
            const stats = window.crm.getStats();
            document.getElementById('coaches-count').textContent = stats.coaches;
            document.getElementById('clients-count').textContent = stats.clients;
            document.getElementById('lessons-count').textContent = stats.lessons;
            document.getElementById('revenue-count').textContent = stats.revenue.toLocaleString('ru-RU') + ' ₽';
        }

        function loadCoachesTable() {
            const tableBody = document.getElementById('coaches-table-body');
            const emptyState = document.getElementById('coaches-empty');
            tableBody.innerHTML = '';
            
            const coaches = window.crm.coaches;
            
            if (coaches.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            coaches.forEach(coach => {
                const clients = window.crm.getCoachClients(coach.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${coach.name}</td>
                    <td>${coach.style}</td>
                    <td>${coach.phone}</td>
                    <td>${coach.classesPerWeek}</td>
                    <td><strong>${clients.length}</strong></td>
                    <td><span class="status ${coach.status === 'Активен' ? 'status-active' : 'status-inactive'}">${coach.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit edit-coach" data-id="${coach.id}">
                                <i class="fas fa-edit"></i> Изменить
                            </button>
                            <button class="btn btn-delete delete-coach" data-id="${coach.id}">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Обработчики кнопок
            document.querySelectorAll('.edit-coach').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openCoachModal(id);
                });
            });
            
            document.querySelectorAll('.delete-coach').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить тренера? Все его клиенты и занятия также будут удалены.')) {
                        window.crm.deleteCoach(id);
                        loadAllData();
                        showNotification('Тренер удален', 'success');
                    }
                });
            });
        }

        function loadClientsTable() {
            const tableBody = document.getElementById('clients-table-body');
            const emptyState = document.getElementById('clients-empty');
            tableBody.innerHTML = '';
            
            const clients = window.crm.clients;
            
            if (clients.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            clients.forEach(client => {
                const coach = window.crm.getCoach(client.coachId);
                const coachName = coach ? coach.name : 'Не назначен';
                
                const lesson = client.lessonId ? window.crm.getLesson(client.lessonId) : null;
                const lessonName = lesson ? `${lesson.title} (${lesson.day}, ${lesson.time})` : 'Не назначено';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.phone}</td>
                    <td>${client.style}</td>
                    <td>${coachName}</td>
                    <td>${lessonName}</td>
                    <td>${client.visits || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit edit-client" data-id="${client.id}">
                                <i class="fas fa-edit"></i> Изменить
                            </button>
                            <button class="btn btn-delete delete-client" data-id="${client.id}">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Обработчики кнопок
            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openClientModal(id);
                });
            });
            
            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить клиента? Все его платежи также будут удалены.')) {
                        window.crm.deleteClient(id);
                        loadAllData();
                        showNotification('Клиент удален', 'success');
                    }
                });
            });
        }

        function loadSchedule() {
            const container = document.getElementById('schedule-container');
            const emptyState = document.getElementById('schedule-empty');
            container.innerHTML = '';
            
            const lessons = window.crm.lessons;
            
            if (lessons.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Сортируем занятия по дням недели
            const daysOrder = window.crm.getWeekDays().sort((a, b) => a.order - b.order);
            const sortedLessons = [...lessons].sort((a, b) => {
                const dayA = daysOrder.findIndex(d => d.name === a.day);
                const dayB = daysOrder.findIndex(d => d.name === b.day);
                return dayA - dayB;
            });
            
            sortedLessons.forEach(lesson => {
                const coach = window.crm.getCoach(lesson.coachId);
                const coachName = coach ? coach.name : 'Не назначен';
                const clients = window.crm.getClientsByLesson(lesson.id);
                const capacityPercent = Math.round((clients.length / lesson.maxClients) * 100);
                const isFull = clients.length >= lesson.maxClients;
                
                const card = document.createElement('div');
                card.className = 'schedule-card';
                card.innerHTML = `
                    <h4>${lesson.title}</h4>
                    <div class="schedule-time">${lesson.time}</div>
                    <div class="schedule-info">
                        <i class="fas fa-calendar-day"></i>
                        <span>${lesson.day}</span>
                    </div>
                    <div class="schedule-info">
                        <i class="fas fa-user"></i>
                        <span>${coachName}</span>
                    </div>
                    <div class="schedule-info">
                        <i class="fas fa-users"></i>
                        <span>${clients.length} из ${lesson.maxClients} мест</span>
                    </div>
                    
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: ${capacityPercent}%;"></div>
                    </div>
                    <div class="capacity-info">
                        <span>Наполняемость: ${capacityPercent}%</span>
                        <span class="status ${isFull ? 'status-full' : 'status-available'}">
                            ${isFull ? 'Занято' : 'Есть места'}
                        </span>
                    </div>
                    
                    ${clients.length > 0 ? `
                        <div class="clients-list">
                            <strong>Клиенты:</strong>
                            ${clients.map(client => `
                                <div class="client-item">
                                    <div>
                                        <div class="client-name">${client.name}</div>
                                        <div class="client-phone">${client.phone}</div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm remove-client" 
                                            data-client-id="${client.id}" 
                                            data-lesson-id="${lesson.id}"
                                            style="padding: 3px 8px; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-edit edit-lesson" data-id="${lesson.id}" style="margin-right: 5px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-delete delete-lesson" data-id="${lesson.id}" style="margin-right: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-duplicate duplicate-lesson" data-id="${lesson.id}">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Обработчики кнопок
            document.querySelectorAll('.edit-lesson').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openLessonModal(id);
                });
            });
            
            document.querySelectorAll('.delete-lesson').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить занятие? Клиенты будут откреплены от этого занятия.')) {
                        window.crm.deleteLesson(id);
                        loadAllData();
                        showNotification('Занятие удалено', 'success');
                    }
                });
            });
            
            document.querySelectorAll('.duplicate-lesson').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    duplicateLesson(id);
                });
            });
            
            document.querySelectorAll('.remove-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = parseInt(this.getAttribute('data-client-id'));
                    const lessonId = parseInt(this.getAttribute('data-lesson-id'));
                    
                    if (confirm('Открепить клиента от занятия?')) {
                        const client = window.crm.getClient(clientId);
                        if (client) {
                            client.lessonId = null;
                            window.crm.saveAll();
                            loadSchedule();
                            showNotification('Клиент откреплен от занятия', 'success');
                        }
                    }
                });
            });
        }

        function updateWeekScheduleView() {
            const container = document.getElementById('week-schedule');
            container.innerHTML = '';
            
            const days = window.crm.getWeekDays().sort((a, b) => a.order - b.order);
            
            days.forEach(day => {
                const dayLessons = window.crm.getLessonsByDay(day.name);
                
                const dayCard = document.createElement('div');
                dayCard.className = 'settings-card';
                dayCard.innerHTML = `
                    <h4>${day.name}</h4>
                    ${dayLessons.length === 0 ? 
                        '<p style="color: #666; font-style: italic;">Нет занятий</p>' : 
                        dayLessons.map(lesson => {
                            const coach = window.crm.getCoach(lesson.coachId);
                            const coachName = coach ? coach.name : 'Не назначен';
                            const clients = window.crm.getClientsByLesson(lesson.id);
                            const capacityPercent = Math.round((clients.length / lesson.maxClients) * 100);
                            const isFull = clients.length >= lesson.maxClients;
                            
                            return `
                                <div class="schedule-item" style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${lesson.time}</strong> - ${lesson.title}
                                            <div style="font-size: 14px; color: #666;">
                                                ${coachName} • ${clients.length}/${lesson.maxClients} мест
                                                <span class="status ${isFull ? 'status-full' : 'status-available'}" style="margin-left: 10px;">
                                                    ${isFull ? 'Занято' : 'Есть места'}
                                                </span>
                                            </div>
                                            <div class="capacity-bar" style="width: 100%; margin: 5px 0;">
                                                <div class="capacity-fill" style="width: ${capacityPercent}%;"></div>
                                            </div>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn btn-edit edit-lesson" data-id="${lesson.id}" style="padding: 5px 10px;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')
                    }
                `;
                container.appendChild(dayCard);
            });
            
            // Обработчики кнопок
            document.querySelectorAll('.edit-lesson').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openLessonModal(id);
                });
            });
        }

        function loadPaymentsTable() {
            const tableBody = document.getElementById('payments-table-body');
            const emptyState = document.getElementById('payments-empty');
            tableBody.innerHTML = '';
            
            const payments = window.crm.payments;
            
            if (payments.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Сортируем по дате (новые сверху)
            const sortedPayments = [...payments].sort((a, b) => {
                try {
                    return new Date(b.date) - new Date(a.date);
                } catch {
                    return 0;
                }
            });
            
            sortedPayments.forEach(payment => {
                const client = window.crm.getClient(payment.clientId);
                // Если клиент удален, показываем "Клиент удален"
                const clientName = client ? client.name : 'Клиент удален';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${clientName}</td>
                    <td>${payment.date}</td>
                    <td>${payment.amount} ₽</td>
                    <td>${payment.type}</td>
                    <td><span class="status ${payment.status === 'Оплачен' ? 'status-paid' : 'status-pending'}">${payment.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit edit-payment" data-id="${payment.id}">
                                <i class="fas fa-edit"></i> Изменить
                            </button>
                            <button class="btn btn-delete delete-payment" data-id="${payment.id}">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Обработчики кнопок
            document.querySelectorAll('.edit-payment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openPaymentModal(id);
                });
            });
            
            document.querySelectorAll('.delete-payment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить платеж?')) {
                        window.crm.deletePayment(id);
                        loadAllData();
                        showNotification('Платеж удален', 'success');
                    }
                });
            });
        }

        function loadTodayLessons() {
            const upcomingContainer = document.getElementById('upcoming-lessons');
            const lessonsEmpty = document.getElementById('dashboard-lessons-empty');
            upcomingContainer.innerHTML = '';
            
            const today = new Date();
            const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const todayName = days[today.getDay()];
            
            const todayLessons = window.crm.lessons.filter(l => l.day === todayName);
            
            if (todayLessons.length === 0) {
                lessonsEmpty.style.display = 'block';
                return;
            }
            
            lessonsEmpty.style.display = 'none';
            
            // Сортируем по времени
            todayLessons.sort((a, b) => {
                const timeA = a.time.split('-')[0]?.trim() || '';
                const timeB = b.time.split('-')[0]?.trim() || '';
                return timeA.localeCompare(timeB);
            });
            
            todayLessons.forEach(lesson => {
                const coach = window.crm.getCoach(lesson.coachId);
                const coachName = coach ? coach.name : 'Не назначен';
                const clients = window.crm.getClientsByLesson(lesson.id);
                const capacityPercent = Math.round((clients.length / lesson.maxClients) * 100);
                const isFull = clients.length >= lesson.maxClients;
                
                const card = document.createElement('div');
                card.className = 'schedule-card';
                card.innerHTML = `
                    <h4>${lesson.title}</h4>
                    <div class="schedule-time">${lesson.time}</div>
                    <div class="schedule-info">
                        <i class="fas fa-calendar-day"></i>
                        <span>${todayName}</span>
                    </div>
                    <div class="schedule-info">
                        <i class="fas fa-user"></i>
                        <span>${coachName}</span>
                    </div>
                    <div class="schedule-info">
                        <i class="fas fa-users"></i>
                        <span>${clients.length} из ${lesson.maxClients} мест</span>
                    </div>
                    
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: ${capacityPercent}%;"></div>
                    </div>
                    <div class="capacity-info">
                        <span>Наполняемость: ${capacityPercent}%</span>
                        <span class="status ${isFull ? 'status-full' : 'status-available'}">
                            ${isFull ? 'Занято' : 'Есть места'}
                        </span>
                    </div>
                `;
                upcomingContainer.appendChild(card);
            });
        }

        function loadRecentPayments() {
            const recentPaymentsBody = document.getElementById('recent-payments-body');
            const paymentsEmpty = document.getElementById('dashboard-payments-empty');
            recentPaymentsBody.innerHTML = '';
            
            const payments = window.crm.payments;
            
            if (payments.length === 0) {
                paymentsEmpty.style.display = 'block';
                return;
            }
            
            paymentsEmpty.style.display = 'none';
            
            // Показываем последние 5 платежей
            const sortedPayments = [...payments].sort((a, b) => {
                try {
                    return new Date(b.date) - new Date(a.date);
                } catch {
                    return 0;
                }
            }).slice(0, 5);
            
            sortedPayments.forEach(payment => {
                const client = window.crm.getClient(payment.clientId);
                const clientName = client ? client.name : 'Клиент удален';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${clientName}</td>
                    <td>${payment.date}</td>
                    <td>${payment.amount} ₽</td>
                    <td>${payment.type}</td>
                    <td><span class="status ${payment.status === 'Оплачен' ? 'status-paid' : 'status-pending'}">${payment.status}</span></td>
                `;
                recentPaymentsBody.appendChild(row);
            });
        }

        function loadDistribution() {
            const distribution = window.crm.getDistributionData();
            
            // Распределение по тренерам
            const coachContainer = document.getElementById('coach-distribution');
            coachContainer.innerHTML = '';
            
            if (Object.keys(distribution.coaches).length === 0) {
                coachContainer.innerHTML = '<p style="color: #666; font-style: italic;">Нет тренеров с клиентами</p>';
            } else {
                Object.values(distribution.coaches).forEach(data => {
                    const coachItem = document.createElement('div');
                    coachItem.className = 'coach-item';
                    coachItem.innerHTML = `
                        <div class="coach-name">
                            ${data.coach.name}
                            <span class="client-count">${data.count} клиентов</span>
                        </div>
                        ${data.clients.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${data.clients.map(client => `
                                    <div style="padding: 8px; background: white; border-radius: 5px; margin-bottom: 5px; border-left: 3px solid #8a2387;">
                                        <div style="font-weight: 500;">${client.name}</div>
                                        <div style="font-size: 12px; color: #666;">${client.phone}</div>
                                        ${client.lessonId ? `<div style="font-size: 11px; color: #888;">Занятие: ${window.crm.getLesson(client.lessonId)?.title || 'Не указано'}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color: #666; font-style: italic;">Нет клиентов</p>'}
                    `;
                    coachContainer.appendChild(coachItem);
                });
            }
            
            // Распределение по занятиям
            const lessonsContainer = document.getElementById('lessons-distribution');
            lessonsContainer.innerHTML = '';
            
            if (Object.keys(distribution.lessons).length === 0) {
                lessonsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Нет занятий с клиентами</p>';
            } else {
                Object.values(distribution.lessons).forEach(data => {
                    const capacityPercent = data.capacity;
                    const isFull = data.count >= data.lesson.maxClients;
                    
                    const lessonItem = document.createElement('div');
                    lessonItem.className = 'coach-item';
                    lessonItem.innerHTML = `
                        <div class="coach-name">
                            ${data.lesson.title}
                            <span class="status ${isFull ? 'status-full' : 'status-available'}" style="font-size: 12px;">
                                ${data.count}/${data.lesson.maxClients}
                            </span>
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            ${data.lesson.day}, ${data.lesson.time} • ${data.coach?.name || 'Тренер не указан'}
                        </div>
                        
                        <div class="capacity-bar">
                            <div class="capacity-fill" style="width: ${capacityPercent}%;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Наполняемость: ${capacityPercent}%
                        </div>
                        
                        ${data.clients.length > 0 ? `
                            <div style="margin-top: 15px; max-height: 150px; overflow-y: auto;">
                                ${data.clients.map(client => `
                                    <div style="padding: 6px; background: white; border-radius: 3px; margin-bottom: 3px; font-size: 13px;">
                                        ${client.name} • ${client.phone}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color: #666; font-style: italic; margin-top: 10px;">Нет клиентов</p>'}
                    `;
                    lessonsContainer.appendChild(lessonItem);
                });
            }
        }

        function loadSettings() {
            // Направления танцев
            const stylesList = document.getElementById('dance-styles-list');
            const styles = window.crm.getDanceStyles();
            stylesList.innerHTML = '';
            
            styles.forEach(style => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div>
                        <strong>${style.icon || ''} ${style.name}</strong>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                            <div>Возраст: ${style.ageGroup || 'Не указан'}</div>
                            <div>Расписание: ${style.schedule || 'Не указано'}</div>
                            ${style.description ? `<div style="margin-top: 5px;">${style.description}</div>` : ''}
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-edit edit-style" data-id="${style.id}" style="padding: 5px 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-delete delete-style" data-id="${style.id}" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                stylesList.appendChild(item);
            });
            
            // Стоимость занятий
            const pricesList = document.getElementById('prices-list');
            const prices = window.crm.getPrices();
            pricesList.innerHTML = '';
            
            prices.forEach(price => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div>
                        <strong>${price.name}</strong>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                            <span class="price-badge">${price.price === 0 ? 'По запросу' : price.price + '₽'}</span>
                            ${price.period ? ` • ${price.period}` : ''}
                            ${price.ageGroup ? ` • ${price.ageGroup}` : ''}
                            ${price.description ? `<div style="margin-top: 5px;">${price.description}</div>` : ''}
                            ${price.features && price.features.length > 0 ? `
                                <div style="margin-top: 5px; font-size: 12px; color: #888;">
                                    Включено:
                                    <ul style="margin: 5px 0 0 15px; padding: 0;">
                                        ${price.features.map(feature => `<li>${feature}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-edit edit-price" data-id="${price.id}" style="padding: 5px 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-delete delete-price" data-id="${price.id}" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                pricesList.appendChild(item);
            });
            
            // Типы платежей
            const paymentTypesList = document.getElementById('payment-types-list');
            const paymentTypes = window.crm.getPaymentTypes();
            paymentTypesList.innerHTML = '';
            
            paymentTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div>
                        <strong>${type.name}</strong>
                        ${type.description ? `<div style="font-size: 14px; color: #666;">${type.description}</div>` : ''}
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-edit edit-payment-type" data-id="${type.id}" style="padding: 5px 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-delete delete-payment-type" data-id="${type.id}" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                paymentTypesList.appendChild(item);
            });
            
            // Дни недели
            const weekDaysList = document.getElementById('week-days-list');
            const weekDays = window.crm.getWeekDays();
            weekDaysList.innerHTML = '';
            
            weekDays.forEach(day => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div>
                        <strong>${day.name}</strong>
                        <div style="font-size: 14px; color: #666;">${day.shortName} (порядок: ${day.order})</div>
                    </div>
                `;
                weekDaysList.appendChild(item);
            });
            
            // Обработчики кнопок настроек
            document.querySelectorAll('.edit-style').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openSettingsModal('danceStyle', id);
                });
            });
            
            document.querySelectorAll('.delete-style').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить направление?')) {
                        window.crm.deleteDanceStyle(id);
                        loadSettings();
                        loadAllData();
                        showNotification('Направление удалено', 'success');
                    }
                });
            });
            
            document.querySelectorAll('.edit-price').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openSettingsModal('price', id);
                });
            });
            
            document.querySelectorAll('.delete-price').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить стоимость?')) {
                        window.crm.deletePrice(id);
                        loadSettings();
                        showNotification('Стоимость удалена', 'success');
                    }
                });
            });
            
            document.querySelectorAll('.edit-payment-type').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openSettingsModal('paymentType', id);
                });
            });
            
            document.querySelectorAll('.delete-payment-type').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Удалить тип платежа?')) {
                        window.crm.deletePaymentType(id);
                        loadSettings();
                        showNotification('Тип платежа удален', 'success');
                    }
                });
            });
        }

        // Функции работы с модальными окнами
        function openCoachModal(id = null) {
            const form = document.getElementById('coach-form');
            const modalTitle = document.getElementById('coach-modal-title');
            const styleSelect = document.getElementById('coach-style');
            
            // Заполняем список направлений
            styleSelect.innerHTML = '<option value="">Выберите направление</option>';
            window.crm.getDanceStyles().forEach(style => {
                const option = document.createElement('option');
                option.value = style.name;
                option.textContent = style.name;
                styleSelect.appendChild(option);
            });
            
            if (id) {
                // Редактирование
                const coach = window.crm.getCoach(id);
                if (!coach) return;
                
                modalTitle.textContent = 'Редактировать тренера';
                document.getElementById('coach-id').value = coach.id;
                document.getElementById('coach-name').value = coach.name;
                document.getElementById('coach-phone').value = coach.phone;
                document.getElementById('coach-style').value = coach.style;
                document.getElementById('coach-classes').value = coach.classesPerWeek;
                document.getElementById('coach-status').value = coach.status;
            } else {
                // Добавление
                modalTitle.textContent = 'Добавить тренера';
                form.reset();
                document.getElementById('coach-id').value = '';
                document.getElementById('coach-classes').value = '10';
                document.getElementById('coach-status').value = 'Активен';
            }
            
            document.getElementById('coach-modal').classList.add('active');
        }

        function openClientModal(id = null) {
            const form = document.getElementById('client-form');
            const modalTitle = document.getElementById('client-modal-title');
            const styleSelect = document.getElementById('client-style');
            const coachSelect = document.getElementById('client-coach');
            const lessonSelect = document.getElementById('client-lesson');
            
            // Заполняем список направлений
            styleSelect.innerHTML = '<option value="">Выберите направление</option>';
            window.crm.getDanceStyles().forEach(style => {
                const option = document.createElement('option');
                option.value = style.name;
                option.textContent = style.name;
                styleSelect.appendChild(option);
            });
            
            // Заполняем список тренеров
            coachSelect.innerHTML = '<option value="">Выберите тренера</option>';
            window.crm.getActiveCoaches().forEach(coach => {
                const option = document.createElement('option');
                option.value = coach.id;
                option.textContent = coach.name;
                coachSelect.appendChild(option);
            });
            
            // Заполняем список занятий
            lessonSelect.innerHTML = '<option value="">Не выбрано</option>';
            window.crm.lessons.forEach(lesson => {
                const coach = window.crm.getCoach(lesson.coachId);
                const coachName = coach ? coach.name : 'Неизвестно';
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = `${lesson.title} (${lesson.day}, ${lesson.time}, ${coachName})`;
                lessonSelect.appendChild(option);
            });
            
            if (id) {
                // Редактирование
                const client = window.crm.getClient(id);
                if (!client) return;
                
                modalTitle.textContent = 'Редактировать клиента';
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name;
                document.getElementById('client-phone').value = client.phone;
                document.getElementById('client-email').value = client.email || '';
                document.getElementById('client-birthdate').value = client.birthdate || '';
                document.getElementById('client-style').value = client.style;
                document.getElementById('client-coach').value = client.coachId;
                document.getElementById('client-lesson').value = client.lessonId || '';
            } else {
                // Добавление
                modalTitle.textContent = 'Добавить клиента';
                form.reset();
                document.getElementById('client-id').value = '';
            }
            
            document.getElementById('client-modal').classList.add('active');
        }

        function openLessonModal(id = null) {
            const form = document.getElementById('lesson-form');
            const modalTitle = document.getElementById('lesson-modal-title');
            const styleSelect = document.getElementById('lesson-style');
            const daySelect = document.getElementById('lesson-day');
            const coachSelect = document.getElementById('lesson-coach');
            
            // Заполняем список направлений
            styleSelect.innerHTML = '<option value="">Выберите направление</option>';
            window.crm.getDanceStyles().forEach(style => {
                const option = document.createElement('option');
                option.value = style.name;
                option.textContent = style.name;
                styleSelect.appendChild(option);
            });
            
            // Заполняем список дней недели
            daySelect.innerHTML = '<option value="">Выберите день</option>';
            window.crm.getWeekDays().sort((a, b) => a.order - b.order).forEach(day => {
                const option = document.createElement('option');
                option.value = day.name;
                option.textContent = day.name;
                daySelect.appendChild(option);
            });
            
            // Заполняем список тренеров
            coachSelect.innerHTML = '<option value="">Выберите тренера</option>';
            window.crm.getActiveCoaches().forEach(coach => {
                const option = document.createElement('option');
                option.value = coach.id;
                option.textContent = coach.name;
                coachSelect.appendChild(option);
            });
            
            // Скрываем секцию дублирования
            document.getElementById('duplicate-section').style.display = 'none';
            document.getElementById('toggle-duplicate-btn').innerHTML = '<i class="fas fa-copy"></i> Добавить дублирование';
            document.getElementById('toggle-duplicate-btn').classList.remove('btn-duplicate');
            document.getElementById('toggle-duplicate-btn').classList.add('btn-secondary');
            
            if (id) {
                // Редактирование
                const lesson = window.crm.getLesson(id);
                if (!lesson) return;
                
                modalTitle.textContent = 'Редактировать занятие';
                document.getElementById('lesson-id').value = lesson.id;
                document.getElementById('lesson-title').value = lesson.title;
                document.getElementById('lesson-style').value = lesson.style;
                document.getElementById('lesson-day').value = lesson.day;
                document.getElementById('lesson-time').value = lesson.time;
                document.getElementById('lesson-coach').value = lesson.coachId;
                document.getElementById('lesson-max-clients').value = lesson.maxClients;
            } else {
                // Добавление
                modalTitle.textContent = 'Добавить занятие';
                form.reset();
                document.getElementById('lesson-id').value = '';
                document.getElementById('lesson-max-clients').value = '12';
            }
            
            document.getElementById('lesson-modal').classList.add('active');
        }

        function loadDuplicateDays() {
            const duplicateDaysContainer = document.getElementById('duplicate-days');
            duplicateDaysContainer.innerHTML = '';
            
            const selectedDay = document.getElementById('lesson-day').value;
            const weekDays = window.crm.getWeekDays().sort((a, b) => a.order - b.order);
            
            weekDays.forEach(day => {
                if (day.name !== selectedDay) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'day-checkbox';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="day-${day.id}" value="${day.name}">
                        <label for="day-${day.id}">${day.name} (${day.shortName})</label>
                    `;
                    duplicateDaysContainer.appendChild(checkbox);
                }
            });
        }

        function openPaymentModal(id = null) {
            const form = document.getElementById('payment-form');
            const modalTitle = document.getElementById('payment-modal-title');
            const clientSelect = document.getElementById('payment-client');
            const typeSelect = document.getElementById('payment-type');
            
            // Заполняем список клиентов
            clientSelect.innerHTML = '<option value="">Выберите клиента</option>';
            window.crm.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
            
            // Заполняем список типов платежей
            typeSelect.innerHTML = '<option value="">Выберите тип</option>';
            window.crm.getPaymentTypes().forEach(type => {
                const option = document.createElement('option');
                option.value = type.name;
                option.textContent = type.name;
                typeSelect.appendChild(option);
            });
            
            // Устанавливаем сегодняшнюю дату по умолчанию
            const today = new Date().toISOString().split('T')[0];
            
            if (id) {
                // Редактирование
                const payment = window.crm.getPayment(id);
                if (!payment) return;
                
                modalTitle.textContent = 'Редактировать платеж';
                document.getElementById('payment-id').value = payment.id;
                document.getElementById('payment-client').value = payment.clientId;
                document.getElementById('payment-date').value = payment.date;
                document.getElementById('payment-amount').value = payment.amount;
                document.getElementById('payment-type').value = payment.type;
                document.getElementById('payment-status').value = payment.status;
                document.getElementById('payment-notes').value = payment.notes || '';
            } else {
                // Добавление
                modalTitle.textContent = 'Добавить платеж';
                form.reset();
                document.getElementById('payment-id').value = '';
                document.getElementById('payment-date').value = today;
                document.getElementById('payment-status').value = 'Оплачен';
            }
            
            document.getElementById('payment-modal').classList.add('active');
        }

        function openSettingsModal(type, id = null) {
            const form = document.getElementById('settings-form');
            const modalTitle = document.getElementById('settings-modal-title');
            const priceContainer = document.getElementById('settings-price-container');
            const durationContainer = document.getElementById('settings-duration-container');
            
            // Настраиваем поля в зависимости от типа
            if (type === 'price') {
                priceContainer.style.display = 'block';
                durationContainer.style.display = 'block';
                modalTitle.textContent = id ? 'Редактировать стоимость' : 'Добавить стоимость';
            } else if (type === 'danceStyle') {
                priceContainer.style.display = 'none';
                durationContainer.style.display = 'none';
                modalTitle.textContent = id ? 'Редактировать направление' : 'Добавить направление';
            } else if (type === 'paymentType') {
                priceContainer.style.display = 'none';
                durationContainer.style.display = 'none';
                modalTitle.textContent = id ? 'Редактировать тип платежа' : 'Добавить тип платежа';
            }
            
            if (id) {
                // Редактирование
                let data;
                if (type === 'danceStyle') {
                    data = window.crm.getDanceStyles().find(s => s.id === id);
                } else if (type === 'price') {
                    data = window.crm.getPrices().find(p => p.id === id);
                } else if (type === 'paymentType') {
                    data = window.crm.getPaymentTypes().find(t => t.id === id);
                }
                
                if (data) {
                    document.getElementById('settings-id').value = data.id;
                    document.getElementById('settings-name').value = data.name;
                    document.getElementById('settings-description').value = data.description || '';
                    if (type === 'price') {
                        document.getElementById('settings-price').value = data.price || '';
                        document.getElementById('settings-duration').value = data.period || '8 занятий';
                    }
                }
            } else {
                // Добавление
                form.reset();
                document.getElementById('settings-id').value = '';
                if (type === 'price') {
                    document.getElementById('settings-duration').value = '8 занятий';
                }
            }
            
            document.getElementById('settings-type').value = type;
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
            const form = document.getElementById(modalId.replace('modal', 'form'));
            if (form) {
                form.reset();
            }
        }

        // Функции сохранения данных
        function saveCoach() {
            const id = document.getElementById('coach-id').value;
            const coachData = {
                name: document.getElementById('coach-name').value,
                phone: document.getElementById('coach-phone').value,
                style: document.getElementById('coach-style').value,
                classesPerWeek: parseInt(document.getElementById('coach-classes').value),
                status: document.getElementById('coach-status').value
            };
            
            let success = false;
            let message = '';
            
            if (id) {
                // Обновление
                success = window.crm.updateCoach(parseInt(id), coachData);
                message = success ? 'Тренер обновлен' : 'Ошибка обновления тренера';
            } else {
                // Добавление
                window.crm.addCoach(coachData);
                success = true;
                message = 'Тренер добавлен';
            }
            
            if (success) {
                closeModal('coach-modal');
                loadAllData();
                showNotification(message, 'success');
            } else {
                showNotification(message, 'error');
            }
        }

        function saveClient() {
            const id = document.getElementById('client-id').value;
            const coachId = document.getElementById('client-coach').value;
            const lessonId = document.getElementById('client-lesson').value;
            
            if (!coachId) {
                showNotification('Выберите тренера', 'error');
                return;
            }
            
            const clientData = {
                name: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                email: document.getElementById('client-email').value || undefined,
                birthdate: document.getElementById('client-birthdate').value || undefined,
                style: document.getElementById('client-style').value,
                coachId: parseInt(coachId),
                lessonId: lessonId ? parseInt(lessonId) : null
            };
            
            let success = false;
            let message = '';
            
            if (id) {
                // Обновление
                success = window.crm.updateClient(parseInt(id), clientData);
                message = success ? 'Клиент обновлен' : 'Ошибка обновления клиента';
            } else {
                // Добавление
                window.crm.addClient(clientData);
                success = true;
                message = 'Клиент добавлен';
            }
            
            if (success) {
                closeModal('client-modal');
                loadAllData();
                showNotification(message, 'success');
            } else {
                showNotification(message, 'error');
            }
        }

        function saveLesson() {
            const id = document.getElementById('lesson-id').value;
            const coachId = document.getElementById('lesson-coach').value;
            const day = document.getElementById('lesson-day').value;
            
            if (!coachId) {
                showNotification('Выберите тренера', 'error');
                return;
            }
            
            if (!day) {
                showNotification('Выберите день недели', 'error');
                return;
            }
            
            const lessonData = {
                title: document.getElementById('lesson-title').value,
                style: document.getElementById('lesson-style').value,
                day: day,
                time: document.getElementById('lesson-time').value,
                coachId: parseInt(coachId),
                maxClients: parseInt(document.getElementById('lesson-max-clients').value)
            };
            
            let success = false;
            let message = '';
            
            // Проверяем, нужно ли дублировать
            const duplicateSection = document.getElementById('duplicate-section');
            const duplicateAllWeeks = document.getElementById('duplicate-all-weeks').checked;
            const duplicateDays = [];
            
            if (duplicateSection.style.display !== 'none') {
                document.querySelectorAll('#duplicate-days input[type="checkbox"]:checked').forEach(checkbox => {
                    duplicateDays.push(checkbox.value);
                });
            }
            
            if (id) {
                // Редактирование (без дублирования)
                success = window.crm.updateLesson(parseInt(id), lessonData);
                message = success ? 'Занятие обновлено' : 'Ошибка обновления занятия';
            } else {
                // Добавление нового занятия
                const lessonsToAdd = [lessonData];
                
                // Добавляем дублированные занятия
                duplicateDays.forEach(duplicateDay => {
                    const duplicateLesson = {
                        ...lessonData,
                        day: duplicateDay
                    };
                    lessonsToAdd.push(duplicateLesson);
                });
                
                // Если выбрано дублирование на 4 недели вперед
                if (duplicateAllWeeks && duplicateDays.length > 0) {
                    // В упрощенной версии просто создаем по одному занятию на каждый выбранный день
                    showNotification(`Создано ${lessonsToAdd.length} занятие(й) на выбранные дни`, 'info');
                }
                
                window.crm.addLessons(lessonsToAdd);
                success = true;
                message = `Добавлено ${lessonsToAdd.length} занятие(й)`;
            }
            
            if (success) {
                closeModal('lesson-modal');
                loadAllData();
                showNotification(message, 'success');
            } else {
                showNotification(message, 'error');
            }
        }

        function duplicateLesson(id) {
            const lesson = window.crm.getLesson(id);
            if (!lesson) return;
            
            openLessonModal(); // Открываем пустую форму
            setTimeout(() => {
                // Заполняем форму данными из выбранного занятия
                document.getElementById('lesson-title').value = lesson.title + ' (копия)';
                document.getElementById('lesson-style').value = lesson.style;
                document.getElementById('lesson-day').value = lesson.day;
                document.getElementById('lesson-time').value = lesson.time;
                document.getElementById('lesson-coach').value = lesson.coachId;
                document.getElementById('lesson-max-clients').value = lesson.maxClients;
                
                // Показываем опции дублирования
                document.getElementById('toggle-duplicate-btn').click();
            }, 100);
        }

        function savePayment() {
            const id = document.getElementById('payment-id').value;
            const clientId = document.getElementById('payment-client').value;
            
            if (!clientId) {
                showNotification('Выберите клиента', 'error');
                return;
            }
            
            const paymentData = {
                clientId: parseInt(clientId),
                date: document.getElementById('payment-date').value,
                amount: document.getElementById('payment-amount').value,
                type: document.getElementById('payment-type').value,
                status: document.getElementById('payment-status').value,
                notes: document.getElementById('payment-notes').value || undefined
            };
            
            let success = false;
            let message = '';
            
            if (id) {
                // Обновление
                success = window.crm.updatePayment(parseInt(id), paymentData);
                message = success ? 'Платеж обновлен' : 'Ошибка обновления платежа';
            } else {
                // Добавление
                window.crm.addPayment(paymentData);
                success = true;
                message = 'Платеж добавлен';
            }
            
            if (success) {
                closeModal('payment-modal');
                loadAllData();
                showNotification(message, 'success');
            } else {
                showNotification(message, 'error');
            }
        }

        function saveSetting() {
            const id = document.getElementById('settings-id').value;
            const type = document.getElementById('settings-type').value;
            const name = document.getElementById('settings-name').value;
            const description = document.getElementById('settings-description').value;
            
            if (!name) {
                showNotification('Введите название', 'error');
                return;
            }
            
            let success = false;
            let message = '';
            
            if (type === 'danceStyle') {
                const styleData = { 
                    name, 
                    description: description || undefined
                };
                
                if (id) {
                    success = window.crm.updateDanceStyle(parseInt(id), styleData);
                    message = success ? 'Направление обновлено' : 'Ошибка обновления направления';
                } else {
                    window.crm.addDanceStyle(styleData);
                    success = true;
                    message = 'Направление добавлено';
                }
            } else if (type === 'price') {
                const price = document.getElementById('settings-price').value;
                const period = document.getElementById('settings-duration').value;
                
                if (!price && price !== 0) {
                    showNotification('Введите стоимость (0 - если по запросу)', 'error');
                    return;
                }
                
                const priceData = { 
                    name, 
                    description: description || undefined,
                    price: parseInt(price) || 0,
                    period: period || '8 занятий'
                };
                
                if (id) {
                    success = window.crm.updatePrice(parseInt(id), priceData);
                    message = success ? 'Стоимость обновлена' : 'Ошибка обновления стоимости';
                } else {
                    window.crm.addPrice(priceData);
                    success = true;
                    message = 'Стоимость добавлена';
                }
            } else if (type === 'paymentType') {
                const typeData = { 
                    name, 
                    description: description || undefined
                };
                
                if (id) {
                    success = window.crm.updatePaymentType(parseInt(id), typeData);
                    message = success ? 'Тип платежа обновлен' : 'Ошибка обновления типа платежа';
                } else {
                    window.crm.addPaymentType(typeData);
                    success = true;
                    message = 'Тип платежа добавлен';
                }
            }
            
            if (success) {
                closeModal('settings-modal');
                loadSettings();
                loadAllData();
                showNotification(message, 'success');
            } else {
                showNotification(message, 'error');
            }
        }

        function exportData() {
            const data = window.crm.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dance-crm-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Данные экспортированы', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    if (confirm('Импортировать данные? Текущие данные будут заменены.')) {
                        const success = window.crm.importData(data);
                        if (success) {
                            loadAllData();
                            showNotification('Данные импортированы', 'success');
                        } else {
                            showNotification('Ошибка импорта данных', 'error');
                        }
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showNotification(message, type = 'info') {
            // Создаем уведомление
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s, fadeOut 0.3s 2.7s;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            `;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#4caf50';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#f44336';
            } else {
                notification.style.backgroundColor = '#2196f3';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Удаляем через 3 секунды
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Добавляем стили для анимации уведомлений
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
